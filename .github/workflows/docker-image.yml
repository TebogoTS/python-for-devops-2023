name: Build and Push Docker Image
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install Buildah
        run: |
          sudo apt-get update
          sudo apt-get install -y buildah

      - name: Authenticate with Artifactory/Docker Hub
        run: |
          echo "{\"auths\":{\"registry.hub.docker.com\": {\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}}}" > my-auth.conf
          buildah login --authfile my-auth.conf registry.hub.docker.com --debug

        env: 
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build with Buildah
        run:
          buildah bud -t  docker.io/mahlomojats/thousandeyes:test .
          
      - name: Buildah list images
        run:
          buildah images
          
      - name: Push with Buildah
        run:
          buildah push  docker.io/mahlomojats/thousandeyes:test
